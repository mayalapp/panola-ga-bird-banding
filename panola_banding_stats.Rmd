---
title: "Panola GA Bird Banding"
author: "Maya Lapp"
date: "12/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(lubridate)

# Note: **PPP** = "Potential problem point" in code if trying to run new data 
```

```{r load_data, warning=FALSE}
# read in files with banding data and recapture data 
recap_data <- read_excel("All Recaps Dec 9 2021.xls") %>% mutate(recap = TRUE)
band_data <- read_excel("All bands Dec 9 2021.xls") %>% mutate(recap = FALSE) %>% 
  rename(Net = `Net/box`)

# data cleaning for banding data
all_data <- recap_data %>% 
  full_join(band_data)  %>% # join recap and band data 
  filter(Location == "PANO") %>% 
  mutate(Time = str_split_fixed(Time, " ", 2)[,2]) %>% # only keep time (not [incorrect] date) **PPP**
  rename(banding_date = `Banding Date`, recapture_date = `Recapture Date`, how_captured = `How Captured`, band_number = `Band Number`, wing_chord = `Wing Chord`) %>%  # rename columns without spaces
  mutate(net_number = as.factor(as.numeric(Net)), Species = as.factor(Species)) %>% # only keep number for nets; change species to factor 
  filter(grepl("net", tolower(how_captured), fixed = TRUE)) %>% 
  mutate(obs_date = coalesce(recapture_date, banding_date)) %>% # create variable for data of observation (banding date if first time captured, otherwise recapture date)
  mutate(obs_yr = as.numeric(format(obs_date, "%Y"))) # create variable for year of observation 
  #mutate(Species = as.character(Species)) #%>% 
  #mutate(Species = ifelse("WPWA", "PAWA", ifelse("YPWA", "PAWA", as.character(Species))))
 

# read in year-cumulative data (ie net hours and unbanded captures)
cumulative_data <- read_excel("pano_year_data.xlsx") 


big_grasslands <- c("BLGR", "COYE", "EABL", "FISP", "INBU", "SAVS", "SWSP", "YBCH")
all_grasslands <- c(big_grasslands, "AMKE", "BOBO", "GRSP", "HESP", "LESP", "LISP", "LOSH", "EAKI", "PRWA", "WISN", "SEWR", "VESP", "YEWA")
# Big ones: Blue Grosbeak, Common Yellowthroat, Eastern Bluebird, Field Sparrow, Indigo Bunting, Savannah Sparrow, Swamp  Sparrow, and Yellow-breasted Chat 
# 
# Additional: American Kestrel, Bobolink, Grasshopper Sparrow, Henslow's Sparrow, LeConte's Sparrow, Lincoln's Sparrow, Loggerhead Shrike, Eastern Kingbird, Prairie Warbler, Wilson's Snipe, Sedge Wren, Vesper Sparrow and Yellow Warbler 
# 
# Western Palm Warbler and Yellow Palm Warbler are 2 subspecies of Palm Warbler and can be lumped for analysis.
# 
# Trail's Flycatcher and Willow Flycatcher are more or less the same species and can be lumped.
# 
# Eastern Phoebe is a WEIRD one.  It's not a grassland bird, but we catch loads of them - and they are almost all recently-fledged juveniles.  And we almost never recapture them.  I really need an analysis of them, but not sure how to handle it.

```
Looking at BPNH
```{r}
bpnh_data <- all_data %>%  
  group_by(obs_yr) %>% 
  summarize(tot_birds = n()) %>%  # number of banded/recaptured birds for each year
  left_join(cumulative_data, by = c("obs_yr" = "year") ) %>% # add net-hours and released bird data
  mutate(tot_birds = tot_birds + unbanded_captures) %>% # include captured but released birds in tot_birds
  select(-unbanded_captures) %>% #drop column
  mutate(bpnh = tot_birds/net_hrs) #calculate birds per net hour 

#all_data %>% filter(recap) %>% group_by(obs_yr) %>% summarize(n())
#all_data %>% filter(!recap) %>% group_by(obs_yr) %>% summarize(n())

bpnh_data  

bpnh_data %>% 
  ggplot(aes(x = obs_yr, y = bpnh)) +
  geom_point()

lm_bpnh <- lm(bpnh~obs_yr, bpnh_data)
summary(lm_bpnh)
```

```{r}
bpnh_data <- all_data %>%  
  group_by(obs_yr, net_number) %>% 
  summarize(tot_birds = n()) %>%  # number of banded/recaptured birds for each year
  left_join(cumulative_data, by = c("obs_yr" = "year") ) %>% # add net-hours and released bird data
  mutate(tot_birds = tot_birds + unbanded_captures) %>% # include captured but released birds in tot_birds
  select(-unbanded_captures) %>% #drop column
  mutate(bpnh = tot_birds/net_hrs) #calculate birds per net hour 

#all_data %>% filter(recap) %>% group_by(obs_yr) %>% summarize(n())
#all_data %>% filter(!recap) %>% group_by(obs_yr) %>% summarize(n())

bpnh_data  

bpnh_data %>% 
  ggplot(aes(x = obs_yr, y = bpnh)) +
  geom_point()

lm_bpnh <- lm(bpnh~obs_yr, bpnh_data)
summary(lm_bpnh)
```


Looking at percentages of species in nets 
```{r}
# calculate total number of birds caught by each net
birds_per_net <- all_data %>% 
  group_by(net_number) %>% 
  summarize(tot_birds= n()) %>% # total number of birds caught in each net
  filter(tot_birds > 1) # ignore nets with only one observation - probably typo **PPP** 

# calculate total number of birds caught by each net for each year 
birds_per_net_per_year <- all_data %>% 
  group_by(net_number, obs_yr) %>% 
  summarize(tot_birds= n()) %>% # total number of birds caught in each net each year
  filter(tot_birds > 1) # ignore nets with only one observation - probably typo **PPP** 

# calculate percent of each species for each net 
net_spec <- all_data %>% 
  group_by(net_number, Species) %>% 
  summarize(num_birds = n()) %>% 
  left_join(birds_per_net) %>% 
  mutate(perc_species = num_birds/tot_birds*100) 
net_spec

# calculate percent of each species for each net for each year 
net_spec_yr <- all_data %>% 
  group_by(net_number, Species, obs_yr) %>% 
  summarize(num_birds = n()) %>% 
  left_join(birds_per_net_per_year) %>% 
  mutate(perc_species = num_birds/tot_birds*100)
net_spec_yr

# create dataframes to export to csv files
net_spec_export <- net_spec %>% select(-tot_birds)
net_spec_yr_export <- net_spec_yr %>% select(-tot_birds)

#export dataframes to csv files named by current date 
write_excel_csv(net_spec_export, file = paste(Sys.Date(), "_net_percSpecies", ".csv", sep = ""))
write_excel_csv(net_spec_yr_export, file = paste(Sys.Date(), "_net_percSpecies_yr", ".csv", sep =""))

```




```{r}
# test example plots 
bird = "CACH"
plot_export <- net_spec_yr %>% 
  filter(Species == bird, net_number !=1719) %>% 
  ggplot(aes(x = obs_yr, y = perc_species))+ 
  geom_point()+
  facet_wrap(~net_number, drop = FALSE) + 
  labs(y = "Percent of Species", x = "Year", title = paste("Percent of", bird, "in nets over time"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
plot_export

plot_export_freey <- net_spec_yr %>% 
  filter(Species == bird, net_number !=1719) %>% 
  ggplot(aes(x = obs_yr, y = perc_species))+ 
  geom_point()+
  facet_wrap(~net_number, drop = FALSE, scales = "free_y") + 
  labs(y = "Percent of Species", x = "Year", title = paste("Percent of", bird, "in nets over time"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
plot_export_freey

ggsave("plot_example.pdf", plot = plot_export, width = 15, height = 10)
ggsave("plot_example_freey.pdf", plot = plot_export_freey, width = 15, height = 10)
```


All nets together 
```{r}
birds_per_year_all_nets <- all_data %>% 
  mutate(obs_yr = format(obs_date, "%Y")) %>% 
  group_by(obs_yr) %>% 
  summarize(tot_birds= n()) #%>% # total number of birds caught in each net

all_nets <- all_data %>% 
  mutate(obs_yr = format(obs_date, "%Y")) %>% 
  group_by(obs_yr, Species) %>% 
  summarize(num_birds =n()) %>% 
  left_join(birds_per_year_all_nets) %>% 
  mutate(perc_species = num_birds/tot_birds*100) 

plot_export_allNets <- all_nets %>% 
  filter(Species == "SOSP") %>% 
  ggplot(aes(x = obs_yr, y = perc_species))+ 
  geom_point()+
  labs(y = "Percent of Species", x = "Year", title = "Percent of SOSP in nets over time")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
plot_export_allNets
```


